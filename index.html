<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Audit System</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.03) 10px,
                rgba(255,255,255,0.03) 20px
            );
            animation: slide 20s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-50px); }
            100% { transform: translateX(50px); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .form-section {
            padding: 40px;
        }

        .audit-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .input-group {
            position: relative;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .table-section {
            margin-top: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .add-row-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-row-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            border: 1px solid #e1e8ed;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
        }

        th {
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        th:last-child {
            border-right: none;
        }

        tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e1e8ed;
        }

        tbody tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: scale(1.01);
        }

        td {
            padding: 15px;
            border-right: 1px solid #e1e8ed;
        }

        td:last-child {
            border-right: none;
        }

        .table-input, .table-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .table-input:focus, .table-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.1);
        }

        .delete-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .actions-section {
            padding: 30px 40px;
            background: #f8f9fa;
            border-top: 1px solid #e1e8ed;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .export-btn, .save-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .export-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .save-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
        }

        .export-btn:hover, .save-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .summary-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
            border-left: 5px solid #2196f3;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1976d2;
            display: block;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .audit-info {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .actions-section {
                flex-direction: column;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-clipboard-check"></i> Manufacturing Audit System</h1>
            <p>Professional Quality Control & Assessment Platform</p>
        </div>

        <!-- Form Section -->
        <div class="form-section">
            <!-- Audit Information -->
            <div class="audit-info">
                <div class="input-group">
                    <label for="auditorName">
                        <i class="fas fa-user"></i> Nama Auditor
                    </label>
                    <input type="text" id="auditorName" placeholder="Masukkan nama auditor">
                </div>
                
                <div class="input-group">
                    <label for="line">
                        <i class="fas fa-industry"></i> Line Production
                    </label>
                    <select id="line">
                        <option value="">Pilih Line</option>
                        <option value="Line 1">Line 1</option>
                        <option value="Line 2">Line 2</option>
                        <option value="Line 3">Line 3</option>
                        <option value="Line 4">Line 4</option>
                        <option value="Line 5">Line 5</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="model">
                        <i class="fas fa-box"></i> Model Produk
                    </label>
                    <input type="text" id="model" placeholder="Masukkan model produk">
                </div>
                
                <div class="input-group">
                    <label for="style">
                        <i class="fas fa-tag"></i> Style Code
                    </label>
                    <input type="text" id="style" placeholder="Masukkan kode style">
                </div>
            </div>

            <!-- Summary Section -->
            <div class="summary-section">
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="summary-value" id="totalItems">0</span>
                        <span class="summary-label">Total Items</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-value" id="totalScore">0</span>
                        <span class="summary-label">Total Score</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-value" id="maxScore">0</span>
                        <span class="summary-label">Max Score</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-value" id="percentage">0%</span>
                        <span class="summary-label">Percentage</span>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-section">
                <div class="table-header">
                    <h2 class="table-title">
                        <i class="fas fa-list-check"></i> Audit Checklist
                    </h2>
                    <button class="add-row-btn" onclick="addRow()">
                        <i class="fas fa-plus"></i> Tambah Item
                    </button>
                </div>

                <div class="table-container">
                    <table id="auditTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Kategori</th>
                                <th>Item Audit</th>
                                <th>Nilai Maksimal</th>
                                <th>Nilai Aktual</th>
                                <th>Keterangan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Actions Section -->
        <div class="actions-section">
            <button class="save-btn" onclick="saveData()">
                <i class="fas fa-save"></i> Simpan Data
            </button>
            <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-download"></i> Download Excel
            </button>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        let rowCounter = 0;
        let auditData = [];

        // Categories for audit
        const categories = [
            'Kebersihan',
            'Keselamatan Kerja',
            'Kualitas Produk',
            'Peralatan',
            'Dokumentasi',
            'Lingkungan Kerja',
            'Proses Produksi',
            'Material Storage',
            'Maintenance',
            'Training & Competency'
        ];

        // Initialize with sample data
        function initializeApp() {
            // Add some sample rows
            for (let i = 1; i <= 3; i++) {
                addRow();
            }
            updateSummary();
            showToast('Aplikasi berhasil dimuat!', 'success');
        }

        // Add new row to audit table
        function addRow() {
            rowCounter++;
            const tbody = document.getElementById('auditTableBody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${rowCounter}</td>
                <td>
                    <select class="table-select" onchange="updateSummary()">
                        <option value="">Pilih Kategori</option>
                        ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <input type="text" class="table-input" placeholder="Masukkan item audit" onchange="updateSummary()">
                </td>
                <td>
                    <input type="number" class="table-input" min="0" max="100" placeholder="100" value="100" onchange="updateSummary()">
                </td>
                <td>
                    <input type="number" class="table-input" min="0" max="100" placeholder="0" onchange="updateSummary()">
                </td>
                <td>
                    <input type="text" class="table-input" placeholder="Keterangan tambahan">
                </td>
                <td>
                    <button class="delete-btn" onclick="deleteRow(this)" title="Hapus baris">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            updateRowNumbers();
            updateSummary();
        }

        // Delete row from table
        function deleteRow(button) {
            if (confirm('Apakah Anda yakin ingin menghapus item ini?')) {
                button.closest('tr').remove();
                updateRowNumbers();
                updateSummary();
                showToast('Item berhasil dihapus!', 'success');
            }
        }

        // Update row numbers after deletion
        function updateRowNumbers() {
            const rows = document.querySelectorAll('#auditTableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
            rowCounter = rows.length;
        }

        // Update summary statistics
        function updateSummary() {
            const rows = document.querySelectorAll('#auditTableBody tr');
            let totalItems = rows.length;
            let totalScore = 0;
            let maxScore = 0;

            rows.forEach(row => {
                const maxVal = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const actualVal = parseFloat(row.cells[4].querySelector('input').value) || 0;
                
                maxScore += maxVal;
                totalScore += actualVal;
            });

            const percentage = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('maxScore').textContent = maxScore;
            document.getElementById('percentage').textContent = percentage + '%';
        }

        // Collect all data from form
        function collectData() {
            const data = {
                auditorInfo: {
                    nama: document.getElementById('auditorName').value,
                    line: document.getElementById('line').value,
                    model: document.getElementById('model').value,
                    style: document.getElementById('style').value,
                    tanggal: new Date().toLocaleDateString('id-ID'),
                    waktu: new Date().toLocaleTimeString('id-ID')
                },
                auditItems: []
            };

            const rows = document.querySelectorAll('#auditTableBody tr');
            rows.forEach((row, index) => {
                const kategori = row.cells[1].querySelector('select').value;
                const audit = row.cells[2].querySelector('input').value;
                const nilaiMaksimal = row.cells[3].querySelector('input').value;
                const nilaiAktual = row.cells[4].querySelector('input').value;
                const keterangan = row.cells[5].querySelector('input').value;

                if (kategori || audit) {  // Only add rows with data
                    data.auditItems.push({
                        no: index + 1,
                        kategori,
                        audit,
                        nilaiMaksimal: parseFloat(nilaiMaksimal) || 0,
                        nilaiAktual: parseFloat(nilaiAktual) || 0,
                        keterangan
                    });
                }
            });

            return data;
        }

        // Save data to localStorage
        function saveData() {
            try {
                const data = collectData();
                
                // Validation
                if (!data.auditorInfo.nama) {
                    throw new Error('Nama auditor harus diisi!');
                }
                if (!data.auditorInfo.line) {
                    throw new Error('Line production harus dipilih!');
                }
                if (data.auditItems.length === 0) {
                    throw new Error('Minimal harus ada satu item audit!');
                }

                localStorage.setItem('auditData', JSON.stringify(data));
                showToast('Data berhasil disimpan!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Export data to Excel
        function exportToExcel() {
            try {
                showLoading(true);
                
                // Check if XLSX library is loaded
                if (typeof XLSX === 'undefined') {
                    throw new Error('Library Excel belum dimuat! Refresh halaman dan coba lagi.');
                }
                
                const data = collectData();
                
                // Validation
                if (!data.auditorInfo.nama) {
                    throw new Error('Nama auditor harus diisi!');
                }
                if (data.auditItems.length === 0) {
                    throw new Error('Tidak ada data audit untuk diekspor!');
                }

                // Create workbook
                const workbook = XLSX.utils.book_new();

                // Sheet 1: Audit Information
                const infoData = [
                    ['MANUFACTURING AUDIT REPORT'],
                    [''],
                    ['Informasi Auditor:'],
                    ['Nama Auditor', data.auditorInfo.nama],
                    ['Line Production', data.auditorInfo.line],
                    ['Model Produk', data.auditorInfo.model],
                    ['Style Code', data.auditorInfo.style],
                    ['Tanggal Audit', data.auditorInfo.tanggal],
                    ['Waktu Audit', data.auditorInfo.waktu],
                    [''],
                    ['Summary:'],
                    ['Total Items', data.auditItems.length],
                    ['Total Score', data.auditItems.reduce((sum, item) => sum + item.nilaiAktual, 0)],
                    ['Max Score', data.auditItems.reduce((sum, item) => sum + item.nilaiMaksimal, 0)],
                    ['Percentage', data.auditItems.length > 0 ? 
                        Math.round((data.auditItems.reduce((sum, item) => sum + item.nilaiAktual, 0) / 
                                   data.auditItems.reduce((sum, item) => sum + item.nilaiMaksimal, 0)) * 100) + '%' : '0%']
                ];

                const infoSheet = XLSX.utils.aoa_to_sheet(infoData);
                XLSX.utils.book_append_sheet(workbook, infoSheet, 'Info Audit');

                // Sheet 2: Audit Details
                const auditHeaders = ['No', 'Kategori', 'Item Audit', 'Nilai Maksimal', 'Nilai Aktual', 'Keterangan'];
                const auditData = [auditHeaders];
                
                data.auditItems.forEach(item => {
                    auditData.push([
                        item.no,
                        item.kategori,
                        item.audit,
                        item.nilaiMaksimal,
                        item.nilaiAktual,
                        item.keterangan
                    ]);
                });

                const auditSheet = XLSX.utils.aoa_to_sheet(auditData);
                XLSX.utils.book_append_sheet(workbook, auditSheet, 'Detail Audit');

                // Generate filename
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                const lineName = data.auditorInfo.line.replace(/\s+/g, '_') || 'Unknown';
                const filename = `Audit_${lineName}_${timestamp}.xlsx`;

                console.log('Attempting to download file:', filename);
                
                // Multiple download methods for better compatibility
                try {
                    // Method 1: Standard XLSX writeFile
                    XLSX.writeFile(workbook, filename);
                    console.log('Download initiated successfully');
                } catch (downloadError) {
                    console.error('Standard download failed, trying alternative method:', downloadError);
                    
                    // Method 2: Manual blob download
                    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    console.log('Alternative download method used');
                }
                
                showLoading(false);
                showToast('File Excel berhasil diunduh! Cek folder Downloads Anda.', 'success');
                
            } catch (error) {
                showLoading(false);
                console.error('Export error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Show loading animation
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Load saved data on page load
        function loadSavedData() {
            const savedData = localStorage.getItem('auditData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // Load auditor info
                    document.getElementById('auditorName').value = data.auditorInfo.nama || '';
                    document.getElementById('line').value = data.auditorInfo.line || '';
                    document.getElementById('model').value = data.auditorInfo.model || '';
                    document.getElementById('style').value = data.auditorInfo.style || '';
                    
                    showToast('Data tersimpan berhasil dimuat!', 'success');
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadSavedData();
        });

        // Auto-save functionality
        setInterval(saveData, 30000); // Auto-save every 30 seconds
    </script>
</body>
</html>
